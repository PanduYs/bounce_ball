<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble Bounce - Fixed Countdown</title>
    <style>
        :root { --primary: #00d4ff; --dark: #1a1a1a; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #game-box { position: relative; width: 400px; height: 600px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        canvas { border: 3px solid #fff; border-radius: 10px; cursor: none; transition: background 1s ease; background: #000; }
        
        .game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.9); border-radius: 10px; z-index: 10; color: white; }
        .btn { width: 180px; padding: 12px; margin: 8px; border-radius: 25px; border: none; cursor: pointer; font-weight: bold; background: white; color: var(--dark); transition: 0.3s; font-size: 14px; text-transform: uppercase; }
        .btn:hover { background: var(--primary); color: white; transform: scale(1.05); }

        #leaderboard-list { width: 80%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        #leaderboard-list th, #leaderboard-list td { padding: 8px; border-bottom: 1px solid #444; text-align: left; }
        .hidden { display: none !important; }
        
        /* Countdown Style */
        #countdown-overlay { background: rgba(0,0,0,0.3); pointer-events: none; }
        #countdown-text { font-size: 100px; font-weight: bold; color: white; text-shadow: 0 0 20px var(--primary); }
    </style>
</head>
<body>

    <audio id="bgMusic" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg"></audio>
    <audio id="bounceSound"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg"></audio>
    <audio id="starSound"><source src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" type="audio/mpeg"></audio>
    <audio id="levelUpSound"><source src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" type="audio/mpeg"></audio>

    <div id="game-box">
        <canvas id="gameCanvas"></canvas>
        
        <div id="countdown-overlay" class="game-ui hidden">
            <div id="countdown-text">3</div>
        </div>

        <div id="game-start-menu" class="game-ui">
            <h1>BUBBLE BOUNCE</h1>
            <p style="color: #ffd700;">High Score: <span id="high-score-display">0</span></p>
            <button class="btn" onclick="startGame()">MULAI BERMAIN</button>
            <button class="btn" onclick="toggleLeaderboard(true)">LEADERBOARD</button>
            <button class="btn" onclick="window.location.reload()">KELUAR</button>
        </div>

        <div id="leaderboard-menu" class="game-ui hidden">
            <h2>TOP 5 PLAYERS</h2>
            <table id="leaderboard-list">
                <thead><tr><th>Nama</th><th>Skor</th><th>Level</th></tr></thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
            <button class="btn" style="margin-top: 20px;" onclick="toggleLeaderboard(false)">KEMBALI</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const bgMusic = document.getElementById("bgMusic");
        const bounceSound = document.getElementById("bounceSound");
        const starSound = document.getElementById("starSound");
        const levelUpSound = document.getElementById("levelUpSound");

        canvas.width = 400; canvas.height = 600;

        let score, lives, level, gameActive = false;
        let isCountingDown = false;
        let stars = [];
        let ball = { x: 200, y: 400, dx: 0, dy: 0, radius: 10 };
        let paddle = { w: 90, h: 15, x: 155, y: 560 };

        const levelConfigs = {
            1: { speed: 4, color: "linear-gradient(#1a2a6c, #b21f1f, #fdbb2d)", next: 500 },
            2: { speed: 5.5, color: "linear-gradient(#0f0c29, #302b63, #24243e)", next: 1200 },
            3: { speed: 6.5, color: "linear-gradient(#134e5e, #71b280)", next: 2500 },
            4: { speed: 8, color: "linear-gradient(#42275a, #734b6d)", next: 4000 },
            5: { speed: 10, color: "linear-gradient(#141e30, #243b55)", next: Infinity }
        };

        function toggleLeaderboard(show) {
            document.getElementById("game-start-menu").classList.toggle("hidden", show);
            document.getElementById("leaderboard-menu").classList.toggle("hidden", !show);
            if(show) updateLeaderboardUI();
        }

        function saveScore(playerName, finalScore, finalLevel) {
            let data = JSON.parse(localStorage.getItem("bubbleBounceLB")) || [];
            data.push({ name: playerName, score: finalScore, level: finalLevel });
            data.sort((a, b) => b.score - a.score);
            data = data.slice(0, 5);
            localStorage.setItem("bubbleBounceLB", JSON.stringify(data));
        }

        function updateLeaderboardUI() {
            const data = JSON.parse(localStorage.getItem("bubbleBounceLB")) || [];
            const body = document.getElementById("leaderboard-body");
            body.innerHTML = data.map(entry => `<tr><td>${entry.name}</td><td>${entry.score}</td><td>${entry.level}</td></tr>`).join("");
            if(data.length > 0) document.getElementById("high-score-display").innerText = data[0].score;
        }

        updateLeaderboardUI();

        function createStars() {
            stars = [];
            for(let i = 0; i < 3; i++) {
                for(let j = 0; j < 5; j++) {
                    stars.push({ x: 45 + (j * 70), y: 80 + (i * 50), active: true });
                }
            }
        }

        function drawStar(cx, cy, spikes, outer, inner) {
            let rot = Math.PI/2*3, x = cx, y = cy, step = Math.PI/spikes;
            ctx.beginPath(); ctx.moveTo(cx, cy-outer);
            for(let i=0; i<spikes; i++){
                x=cx+Math.cos(rot)*outer; y=cy+Math.sin(rot)*outer; ctx.lineTo(x,y); rot+=step;
                x=cx+Math.cos(rot)*inner; y=cy+Math.sin(rot)*inner; ctx.lineTo(x,y); rot+=step;
            }
            ctx.lineTo(cx, cy-outer); ctx.closePath();
            ctx.fillStyle = "#ffd700"; ctx.fill();
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke();
        }

        function startGame() {
            document.getElementById("game-start-menu").classList.add("hidden");
            score = 0; lives = 3; level = 1;
            createStars();
            resetBallPosition();
            gameActive = true; 
            canvas.style.background = levelConfigs[1].color;
            bgMusic.volume = 0.2; bgMusic.play().catch(()=>{});
            
            startCountdown();
            gameLoop(); // Mulai loop gambar
        }

        function startCountdown() {
            isCountingDown = true;
            let count = 3;
            const overlay = document.getElementById("countdown-overlay");
            const text = document.getElementById("countdown-text");
            
            overlay.classList.remove("hidden");
            text.innerText = count;

            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    text.innerText = count;
                } else {
                    clearInterval(timer);
                    overlay.classList.add("hidden");
                    isCountingDown = false; // Bola mulai bergerak
                    setBallVelocity();
                }
            }, 1000);
        }

        function resetBallPosition() {
            ball.x = 200; ball.y = 400;
            ball.dx = 0; ball.dy = 0; 
        }

        function setBallVelocity() {
            ball.dx = levelConfigs[level].speed;
            ball.dy = -levelConfigs[level].speed;
        }

        function update() {
            if(!gameActive || isCountingDown) return;
            
            ball.x += ball.dx; ball.y += ball.dy;

            if(ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) ball.dx *= -1;
            if(ball.y - ball.radius < 0) ball.dy *= -1;

            if(ball.y + ball.radius > paddle.y && ball.x > paddle.x && ball.x < paddle.x + paddle.w) {
                ball.dy = -Math.abs(ball.dy);
                bounceSound.currentTime = 0; bounceSound.play();
            }

            stars.forEach(star => {
                if(star.active) {
                    let d = Math.hypot(ball.x - star.x, ball.y - star.y);
                    if(d < ball.radius + 15) {
                        star.active = false; ball.dy *= -1;
                        score += 10; starSound.currentTime = 0; starSound.play();
                        if(score >= levelConfigs[level].next && level < 5) {
                            level++; levelUpSound.play();
                            canvas.style.background = levelConfigs[level].color;
                            resetBallPosition(); 
                            startCountdown(); 
                            createStars();
                        }
                    }
                }
            });

            if(stars.every(s => !s.active)) createStars();

            if(ball.y > canvas.height) {
                lives--;
                if(lives <= 0) {
                    gameActive = false;
                    bgMusic.pause();
                    const name = prompt("GAME OVER! Masukkan nama Anda:", "Player 1") || "Anonymous";
                    saveScore(name, score, level);
                    updateLeaderboardUI();
                    document.getElementById("game-start-menu").classList.remove("hidden");
                } else {
                    resetBallPosition();
                    startCountdown();
                }
            }
        }

        function draw() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            
            // Render bintang dan paddle tetap jalan saat countdown
            stars.forEach(s => { if(s.active) drawStar(s.x, s.y, 5, 15, 7); });
            
            ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
            ctx.fillStyle = "cyan"; ctx.fill(); ctx.strokeStyle = "white"; ctx.stroke();
            
            ctx.fillStyle = "white"; ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);
            
            ctx.fillStyle = "rgba(0,0,0,0.4)"; ctx.fillRect(0,0, canvas.width, 50);
            ctx.fillStyle = "white"; ctx.font = "bold 14px Arial";
            ctx.fillText("Skor: "+score, 15, 30);
            ctx.fillText("Level: "+level, 180, 30);
            ctx.fillText("❤️ "+lives, 340, 30);
        }

        function gameLoop() {
            if(!gameActive) return;
            draw(); 
            update();
            requestAnimationFrame(gameLoop);
        }

        canvas.addEventListener("mousemove", (e) => {
            let rect = canvas.getBoundingClientRect();
            paddle.x = e.clientX - rect.left - paddle.w/2;
        });
    </script>
</body>
</html>